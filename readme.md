# Telegram Multi-Profile API

REST API на базе **FastAPI** для работы с несколькими Telegram‑профилями из одного приложения. Сервис позволяет авторизовывать Telegram‑аккаунты, управлять ими, получать непрочитанные сообщения и отправлять новые, используя единую точку входа.

## Основные возможности

- Авторизация в нескольких Telegram‑профилях для одного пользователя приложения  
- Управление профилями:
  - привязка нового Telegram‑профиля
  - просмотр списка профилей
- Работа с сообщениями:
  - получение непрочитанных сообщений
  - отправка новых сообщений от выбранного профиля
- JWT‑аутентификация и авторизация:
  - выдача access‑токена при логине
  - проверка и обновление токенов
- Централизованное логирование:
  - логирование запросов/ответов
  - логирование ошибок и ключевых событий авторизации и отправки сообщений

## Архитектура и структура проекта
```
TelegramAPI/
├── app/
│   ├── config/
│   │   ├── __init__.py
│   │   ├── config.py                 # Конфигурация приложения
│   │   └── example.env               # Пример переменных окружения
│   ├── db/                           # Работа с БД
│   │   ├── __init__.py
│   │   ├── models                    # Папки с моделями и обращениями к БД
│   │   └── base.py                   #
│   │   └── database.py               # Инициализация БД
│   ├── middleware/                   # Middleware приложения
│   ├── models/                       # Pydantic модели
│   ├── routers/                      # API маршруты
│   ├── services/
│   │   ├── __init__.py
│   │   ├── auth.py                   # Сервис аутентификации
│   │   └── messages.py               # Сервис сообщений
│   ├── sessions/                     # Управление сессиями
│   ├── __init__.py
│   └── main.py                       # Точка входа приложения
├── tests/
│   ├── conftest.py                   # Конфигурация pytest
│   ├── test_auth.py                  # Тесты аутентификации
│   └── test_messages.py              # Тесты сообщений
├── .env                              # Переменные окружения
├── .gitignore                        # Git ignore файл
├── alembic.ini                       # Конфигурация Alembic
├── docker-compose.yml                # Docker Compose конфигурация
├── Dockerfile                        # Docker образ
├── pytest.ini                        # Конфигурация pytest
├── readme.md                         # Документация проекта
├── requirements.txt                  # Зависимости проекта
└── vector.yaml                       # Конфигурация Vector
```


- **FastAPI** используется как HTTP‑слой: маршрутизация, валидация данных, документация API.
- **SQLAlchemy** отвечает за работу с базой данных (пользователи, Telegram‑сессии, профили, сообщения).
- **JWT** используется для аутентификации пользователей приложения и ограничения доступа к роутам.
- **Логирование** настроено на уровне сервиса и отдельных модулей (авторизация, Telegram‑сообщения и т.п.), что упрощает отладку и мониторинг.

## Краткий сценарий использования

1. Пользователь регистрируется и/или логинится в API и получает JWT‑токен.
2. С помощью авторизованных запросов пользователь привязывает один или несколько Telegram‑профилей.
3. Через соответствующие эндпоинты:
   - получает список своих Telegram‑профилей;
   - запрашивает непрочитанные сообщения;
   - отправляет новые сообщения от выбранного профиля.
4. Все действия логируются, что позволяет отслеживать ошибки и историю операций.


# Telegram Multi-Profile API

## API Endpoints

### Аутентификация

#### Запуск авторизации по номеру телефона
- **POST** `/auth/register`
- Инициализирует процесс авторизации для указанного профиля (отправка кода в Telegram)
- - Тело запроса:
  - `email` — email
  - `password` — пароль

#### Подтверждение кода
- **POST** `/auth/login`
- Позволяет залогиниться уже в существующий аккаунт приложения
- - Тело запроса:
  - `email` — email
  - `password` — пароль
---

### Профили

#### Список профилей
- **GET** `/profiles`
- Возвращает список доступных Telegram-профилей и их состояние


#### Начать авторизацию профиля
- **POST** `/profiles/start`
- Начинает привязку нового Telegram-профиля к текущему пользователю
- Тело запроса:
  - `phone` — номер телефона Telegram‑аккаунта в международном формате
- Результат:
  - статус операции (успех/ошибка)
  - информация о том, был ли отправлен код подтверждения



#### Подтвердить код авторизации профиля
- **POST** `/profiles/code`
- Подтверждает код, отправленный Telegram, и завершает привязку профиля
- Тело запроса:
  - `phone`  — номер телефона Telegram‑аккаунта в международном формате
  - `code` — код подтверждения из Telegram
- Результат:
  - статус операции (профиль успешно привязан / ошибка)
  - обновлённое состояние профиля

#### Подтверждение пароля (2FA)
- **POST** `/profiles/password`
- Подтверждает облачный пароль (если включена двухфакторная аутентификация)
- - Тело запроса:
  - `phone`  — номер телефона Telegram‑аккаунта в международном формате
  - `password`  — пароль
----

### Сообщения и диалоги

#### Получение непрочитанных сообщений
- **GET** `/messages/unread`
- Получает список непрочитанных сообщений для выбранного профиля

#### Отправка сообщения
- **POST** `/messages/send`
- Отправляет сообщение пользователю, чату или каналу от имени выбранного профиля
- Тело запроса:
  - `phone`  — номер телефона Telegram‑аккаунта в международном формате
  - `text`  — текст сообщения
  - `tg_receiver`  — id или username tg получателя

#### Получение непрочитанных сообщений
- **POST** `/messages/unread`
- Получение непрочитанных сообщений
- Тело запроса:
  - `phone`  — номер телефона Telegram‑аккаунта в международном формате


#### Получение диалогов
- **PST** `/messages/dialogs`
- Возвращает список диалогов (чаты, каналы, пользователи) для выбранного профиля
- Тело запроса:
  - `phone`  — номер телефона Telegram‑аккаунта в международном формате
---

### Вспомогательные методы

#### Проверка работоспособности
- **GET** `/health`
- Проверка статуса API и доступности сервиса


#### Информация о текущем профиле/клиенте
- **GET** `/utils/me`
- Возвращает служебную информацию о текущем профиле / клиенте (ID, имя и т.п.)

#### Обновление токенов
- **POST** `/refresh`
- Обновляет refresh и access токены
- 
#### Выход из аккаунта
- **POST** `/logout`
- Удаляет refresh и access токены

---

## Примечания

### В данной реализации требуется внести следующие изменения 

1. **Подключить Alembic для миграций БД**  
   Сейчас таблицы создаются приложением при старте. Для нормальной работы в продакшене и при увеличении числа воркеров нужно перейти на Alembic: он позволит безопасно обновлять структуру БД, хранить историю изменений и запускать миграции отдельно от кода приложения.

2. **Вынести логи в отдельную БД (ClickHouse)**  
   Завести отдельное хранилище для логов запросов, ошибок и бизнес‑событий. Это упростит анализ работы сервиса, построение дашбордов и мониторинг производительности, а также сделает логирование более масштабируемым и удобным для отладки.

3. **Запуск приложения**  
   docker compose up --build -d 
   
